<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="ja" xml:lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="generator" content="PureBuilder Simply WP Importer" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
    <meta name="author" content="Masaki Haruka" />
    <meta name="date" content="2019-09-25T00:00:00+09:00" />
    <meta name="dcterms.date" content="2019-09-25T00:00:00+09:00" />
    <title>(お知らせ) データ飛ばしました - Chienomi</title>
    <style type="text/css">article {
max-width: 1080px;
margin: auto;
}</style>
  </head>
  <body>

    <section id="ContentContainer">
      <header id="MainHeader"><a href="/"><h1>Chienomi</h1></a></header>
      <section id="ArticleBox">
        <header id="ArticleTitle"><h1>(お知らせ) データ飛ばしました</h1></header>
        <article id="MainArticle">
<h2 id="概要">概要</h2>
<p>データを維持広域に渡ってnukeしてしまったので、広範囲に影響が出る。</p>
<h2 id="なにしたの">なにしたの</h2>
<p><code>~/mnt</code>にSSHFS載せたまま<code>rm -r ~/*(#q^D)</code>。</p>
<p>バックアップして、アンマウントし、削除という流れだったのだが、 バックアップ処理中にシャワーを浴びに行ってコンテキストがリセットされてしまったのが致命傷となった。</p>
<h2 id="防げなかった">防げなかった?</h2>
<p>ミスを完全に防ぐことは不可能なので、それについては除外するとすれば、基本的に消去されたデータはメインワークステーションのローカルに に保存されているデータである。 普段はグローバルストレージにバックアップされているが、現在はグローバルストレージが停止中であるためバックアップができなかった。</p>
<p>別ディスクへのバックアップそのものは検討されていたが、タイミングが悪かった。 8月以降は体制が変更されてバックアップされていないのも痛かった。</p>
<h2 id="影響範囲">影響範囲</h2>
<h3 id="概況">概況</h3>
<p>比較的大きいデータは冗長化されたストレージ上にあるため、無事。 また、頻繁に触っているデータに関しても、複数のマシンでMercurialで共有されているから全滅ではない。 さらに、コード関連は <em>公開しているものに限り</em> GitHubなどから書き戻せるため、こちらも全滅ではない。</p>
<p>SSH関連、パスワードマネジメント関連は無事だったため、最悪の自体は回避できている。</p>
<p>ただし、復元不可能な損失はかなり広範囲に渡って発生した。</p>
<h3 id="ウェブ関連">ウェブ関連</h3>
<p>完全に消失したのはHarukamy’s Memoranda及びReasonset。</p>
<p>それ以外に関しては主に7月下旬まで巻き戻った形になる。</p>
<p>どのサイトも原則として復旧するまで更新はできない。 ただ、ChienomiはWordPressであり、ソースデータを必要としない(そもそもソースデータによって生成することができない)ので、Chienomiは更新可能。</p>
<p>消失したサイトを含め、ビルド済みデータは存在しているため、復旧そのものは可能。 ただし、作業量としては非常に多いものとなり、時間がかかる。</p>
<p>また、更新に関しては更新する予定だった内容や草稿が消えてしまったため、出るはずだった原稿の中に消滅してしまうものが出るだろう。</p>
<h3 id="mimir-yokohama関連">Mimir Yokohama関連</h3>
<p>一部のお客様は教材を損失する被害が出たものの、これらは全て私が書き直したので実質的影響はなし。</p>
<p>内部的に参照するデータ、特に10月での料金改定に関するドキュメントが失われたため、若干混乱があるかもしれない。</p>
<h3 id="小説">小説</h3>
<p>最近人気を博している小説については、HEADが別のマシンにあるものであったため、影響は全くない。</p>
<h3 id="コード">コード</h3>
<p><em>公開していないコードは</em> 年単位での巻戻りである。</p>
<p>これはほとんどの人にとって影響がないが、これらの成果物を利用して開発・保守されているものには影響が出る。 (即座に影響が出るものは特にない)</p>
<p>また、内部的にテストしていたコードも失われたため、そのコードを求められた場合も出せなくなった。</p>
<h3 id="全体">全体</h3>
<p>復旧作業が必要であること、作業環境が損壊したことなどから請け負える作業量は低下する。</p>
<h2 id="教訓として">教訓として</h2>
<p>事故リスクを低減する方法がなかったかについては、後の祭りではあるが、以下のようなことが考えられる。</p>
<h3 id="rmのエイリアス">rmのエイリアス</h3>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1"></a><span class="bu">alias</span> rm=<span class="st">&quot;rm --one-file-system&quot;</span></span></code></pre></div>
<p>というのは現実的で良い方法だと思う。</p>
<p>rmのacross filesystemな事故は今回に限らず何度もやっているし、そうあってほしいケースはだいぶ少ない。</p>
<p>もしくは、いっそ<code>~/bin</code>などをシェルスクリプトにして置き換えてしまってもいい。 それなら<code>sudo</code>での事故も減る。</p>
<h3 id="マウントディレクトリのベースディレクトリの書き込み禁止">マウントディレクトリのベースディレクトリの書き込み禁止</h3>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1"></a><span class="fu">mkdir</span> ~/mnt</span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="fu">mkdir</span> ~/mnt/point</span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="fu">sudo</span> chown root:root ~/mnt</span></code></pre></div>
<p>という話だが、これはうまくいかない。 rmの再帰は先にあるファイルを順に消していくためエラーにならないからだ。</p>
<h3 id="readonlyマウント">readonlyマウント</h3>
<p>読み込み専用でマウントする、という方法は有効でありそうに思えるけれども、今回の場合書き込みを目的としていたため不可。</p>
<h3 id="マウントポイントを外に出す">マウントポイントを外に出す</h3>
<p>今回の場合、バックアップ対象がマウントポイントを内包するため、このように処理しようかと考えたものの、FUSEであったためこのようにしなかった。</p>
<p>これは大きな間違いであった。そもそもSSHFSでマウントする必然性に乏しく、全面的にrsyncで処理すべきだったし、作業的にファイルシステムダンプも行われる予定だったからSSHFSを使用した処理そのもの、そしてそれが適切でないと気づいたときに直ちにアンマウントしなかったことが今回の敗因だと言える。</p>

<!-- PBSEARCH_RESULT -->
        </article>
    </section>
    <footer id="InfoFooter">
      <ul>
        <li>© Masaki Haruka 2003.</li>
        <li>Generated by <a href="https://gitlab.com/reasonset/pbsimply-wpimporter">PureBuilder Simply WP Importer</a></li>
      </ul>
    </footer>
  </body>
</html>
