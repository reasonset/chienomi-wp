<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="ja" xml:lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="generator" content="PureBuilder Simply WP Importer" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
    <meta name="author" content="Masaki Haruka" />
    <meta name="date" content="2018-04-06T00:00:00+09:00" />
    <meta name="dcterms.date" content="2018-04-06T00:00:00+09:00" />
    <title>ストレージングの再構成 - Chienomi</title>
    <style type="text/css">article {
max-width: 1080px;
margin: auto;
}</style>
  </head>
  <body>

    <section id="ContentContainer">
      <header id="MainHeader"><a href="/"><h1>Chienomi</h1></a></header>
      <section id="ArticleBox">
        <header id="ArticleTitle"><h1>ストレージングの再構成</h1></header>
        <article id="MainArticle">
<h2 id="序">序</h2>
<p>AoEにしてみたり、複数ボリュームにしてみたり、内蔵で盛ってみたりと様々な手法で拡張を続けてきたストレージだが、ようやくNASを含む構成に変更された。 これにより片側最大192TBのボリュームを確保できるようになった。</p>
<h2 id="nas-readynas528">NAS ReadyNAS528</h2>
<p>NASはReadyNAS 528。</p>
<p>8ベイのNASである。 箱のサイズが随分大きくて驚いてしまったが、本体は8ベイとしては最小限のサイズになっている。</p>
<p>普通に構成するとRAID6になってしまい、選択の余地がない。 一旦ボリュームを削除してから再度作る必要がある。</p>
<p>この際RAID5を選択すると6台以上でのRAID5を推奨しないことを警告される。 この場合は、バックアップもされているので、RAID5で強行する。安心感で言えばRAID6のほうが良いと思う。</p>
<p>そしてiSCSI LUNを作成し、グループに追加する。 残念ながらLUNの最大サイズは全容量の90%とかなり少なく、10%もの領域が余る上に、ディスク全容量の21.25%も削られてしまうことになり、なかなかつらい。フルディスク使える場合はRAID6を使うのとあまり変わらないと考えると余計に辛い。</p>
<p>ReadyNASには暗号化機能があり、起動時に暗号化キーを含むUSBディスクを挿すことで起動できる仕組み。 どうもこれはLUKSによるものであるらしい。</p>
<p>また、ReadyNASは4つものNICを搭載している。 チーミングも可能だが、「グローバルLANへの経路を持つネットワーク」と「ストレージ専用ネットワーク」の2つに同時に接続できるという点は大きい。</p>
<h2 id="btrfsボリュームの構成">Btrfsボリュームの構成</h2>
<p>従来はなんらかのディスク(基本的には物理1台に対して1デバイス)に対してdm-cryptデバイスを作成し、dm-cryptデバイスをBtrfsディスクとして使用していた。</p>
<p>今回はRAIDレイヤー及び暗号化レイヤーはブロックデバイスが保証しているものとして取り扱う。 つまり、「このブロックデバイスは冗長化され、暗号化されたブロックデバイスである」という前提が成り立つようにするわけである。</p>
<p>実際にReadyNSAのボリュームはハードウェア的にRAID化され、その上で暗号化もされている。 Linux上で行う場合はmdまたはLVM RAIDデバイスをLUKSで暗号化するのが有力だろう。</p>
<p>この方式をとることで、「冗長化され暗号化されたiSCSIディスク」を用意することができればいくらでもBtrfsを拡張できるようになり、 従来よりも堅牢性、可用性が向上した。</p>
<h2 id="snashotをsendすると壊れる">snashotをsendすると壊れる</h2>
<p>ところが、実際に使おうとreadonly snapshotをsend/receiveを使って転送すると途中で「読み込み専用ファイルシステム」となってしまい、ファイルシステムが壊れる。</p>
<p>ネットワークデバイスなども疑ったのだが、ログを見る限りiSCSIディスクが応答しなくなって失敗している。 Btrfs的な理由を疑ってMLでも質問したのだが、追求したところどうも「Linuxカーネルの書き込みにネットワークが追いつかず失敗する」ようだった。</p>
<p>この対処方法としては<code>/sys/block/&lt;disk&gt;/queue/max_sectors_kb</code>の値を変更するというものだった。 Manjaro Linuxのデフォルトは<code>8192</code>だが、これを<code>4096</code>とするとトラブルは解消された。 Red Hat Enterprise Linuxでも同様の変更によりトラブルが起きたこともあるようだ。</p>
<p>このディスクについては<code>/dev/disk</code>を使うことができないので自動化が難しい。 やるとしたら次のようなところか。</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode zsh"><code class="sourceCode zsh"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw">typeset</span> -a <span class="ot">disks</span></a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw">for</span> i <span class="kw">in</span> /dev/disk/by-path/*-iscsi-iqn.*</a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="kw">do</span></a>
<a class="sourceLine" id="cb1-4" data-line-number="4">  <span class="ot">disks+=(</span>${<span class="ot">$(</span><span class="kw">readlink</span> -f <span class="ot">$i)</span>##*/}<span class="ot">)</span></a>
<a class="sourceLine" id="cb1-5" data-line-number="5"><span class="kw">done</span></a>
<a class="sourceLine" id="cb1-6" data-line-number="6"></a>
<a class="sourceLine" id="cb1-7" data-line-number="7"><span class="kw">sudo</span> <span class="kw">tee</span> /sys/block/<span class="ot">${disks[@]}</span>/queue/max_sectors_kb <span class="kw">&lt;&lt;&lt;</span> 4096</a></code></pre></div>
<h2 id="おわりに">おわりに</h2>
<p>レイヤーを分担させることができるようになり、ぐっとわかりやすくなった。 また、パフォーマンス面でもそれなりに向上が見られた。コンピュータ自体も刷新されたため体感としては小さいが、起動するコンピュータを問わず簡単にworldストレージをマウントできるようになった点は大きい。</p>
<p><code>max_sectors_kb</code>の問題は盲点で発見に苦労したか、無事問題が解消できてよかった。</p>

<!-- PBSEARCH_RESULT -->
        </article>
    </section>
    <footer id="InfoFooter">
      <ul>
        <li>© Masaki Haruka 2003.</li>
        <li>Generated by <a href="https://gitlab.com/reasonset/pbsimply-wpimporter">PureBuilder Simply WP Importer</a></li>
      </ul>
    </footer>
  </body>
</html>
