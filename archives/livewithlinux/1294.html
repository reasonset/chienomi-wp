<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="ja" xml:lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="generator" content="PureBuilder Simply WP Importer" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
    <meta name="author" content="Masaki Haruka" />
    <meta name="date" content="2018-05-30T00:00:00+09:00" />
    <meta name="dcterms.date" content="2018-05-30T00:00:00+09:00" />
    <title>Linuxで プロセスごとにネットワークを禁止 / インターフェイスを限定 - Chienomi</title>
    <style type="text/css">article {
max-width: 1080px;
margin: auto;
}</style>
  </head>
  <body>

    <section id="ContentContainer">
      <header id="MainHeader"><a href="/"><h1>Chienomi</h1></a></header>
      <section id="ArticleBox">
        <header id="ArticleTitle"><h1>Linuxで プロセスごとにネットワークを禁止 / インターフェイスを限定</h1></header>
        <article id="MainArticle">
<h2 id="特定のプロセスをオフラインにする">特定のプロセスをオフラインにする</h2>
<p>稀にネットワークを禁止した状態で利用したいことがある。 例えば安全性に疑問があるケース、無用な通信が疑われるケース、ファイルをダウンロードできているかの確認などだ。</p>
<p>方法としては</p>
<ul>
<li>cgroupsを使う</li>
<li>iptablesを使う (EUID/EGID単位なら制御可能)</li>
<li>SELinux + iptables を使う</li>
</ul>
<p>の3種類。</p>
<p>単純にネットワークを利用できないようにするのは<code>unshare</code>。</p>
<pre><code>$ sudo unshare -n w3m /some/text/file</code></pre>
<p>環境変数とかXAuthorityとか面倒なので、Firefoxなどを実行するならsudoでrootにしてsudoで戻すのが勧め。</p>
<h2 id="特定のプロセスを特定のゲートウェイから流す">特定のプロセスを特定のゲートウェイから流す</h2>
<p>これだけだと「なんだよ」とか言われてしまうので、もうちょっとまともな話をしよう。</p>
<p>SSH+pppdを使ったVPNは比較的知られているが、VPNはプロキシを通すのに使うか、デフォルトゲートにしてしまうかというのが一般的で、プロセス単位でVPNにルーティングする方法というのはあまり知られていない。</p>
<p>しかしこれもcgroupsを使って実現可能だ。</p>
<p>ここではiptablesによるルーティングを目的とした仮想インターフェイスやブリッジを使うのではなく、あくまで既に割り当てられているインターフェイスを使用させることを目的とする。</p>
<p>まずはトンネルを通しておく。</p>
<pre><code># pppd updetach noauth silent nodeflate pty &quot;/usr/bin/ssh root@gwhost /usr/sbin/pppd nodetach notty noauth&quot; ipparam vpn 10.0.8.1:10.0.8.2</code></pre>
<p>専用に名前空間を作り、pppデバイスを登録する。</p>
<pre><code># ip netns add vpnns
# ip link set ppp0 netns vpnns</code></pre>
<p>pppデバイスにアドレスを与える。 pppは<code>/32</code>プレフィックスがつくのだけど、<code>/32</code>だと通信できないので、<code>/24</code>にしておく。</p>
<pre><code># ip netns exec vpnns ip addr add 10.0.8.1/32 dev ppp0</code></pre>
<p>これで10.0.8.2とは通信できるようになった。 あとはこの状態でシェルを立ち上げ</p>
<pre><code># ip netns exec vpnns bash -l</code></pre>
<p>お好きにどうぞ。</p>
<p>SSH+pppdのトンネルをデフォルトルートにするのはなかなか苦労がある。 もし単純に物理的なインターフェイスをデフォルトルートとして使わせたいのならDHCPが使えて楽。</p>
<pre><code># ip netns exec newns dhcpclient eth1
# ip netns exec newns bash -l</code></pre>
<h2 id="もっと簡単な方法">もっと簡単な方法</h2>
<p>SOCKSを使えばもっと楽にできる。</p>
<pre><code>$ ssh -NCD8080 proxyhost</code></pre>
<p>単純にSOCKS5プロキシとして<code>localhost:8080</code>を指定すればOK。SSH経由で流れてくれる。</p>
<p>SOCKSに対応していないプログラムでも、proxychainsやtsocksを使えばできる場合も多いだろう。</p>
<h2 id="プロセスごとに帯域制限を">プロセスごとに帯域制限を</h2>
<p>cgroupsとtcを使ってください。</p>
<p>現状では理想的に動作しないのでこの話は略。 情報は<a href="https://gist.github.com/descico/6791c7c3045ad5848552">ここらへん</a>にある。</p>

<!-- PBSEARCH_RESULT -->
        </article>
    </section>
    <footer id="InfoFooter">
      <ul>
        <li>© Masaki Haruka 2003.</li>
        <li>Generated by <a href="https://gitlab.com/reasonset/pbsimply-wpimporter">PureBuilder Simply WP Importer</a></li>
      </ul>
    </footer>
  </body>
</html>
