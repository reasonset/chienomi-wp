<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="ja" xml:lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="generator" content="PureBuilder Simply WP Importer" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
    <meta name="author" content="Masaki Haruka" />
    <meta name="date" content="2017-12-12T00:00:00+09:00" />
    <meta name="dcterms.date" content="2017-12-12T00:00:00+09:00" />
    <title>新品コンピュータを初期状態に戻せるようにバックアップ - Chienomi</title>
    <style type="text/css">article {
max-width: 1080px;
margin: auto;
}</style>
  </head>
  <body>

    <section id="ContentContainer">
      <header id="MainHeader"><a href="/"><h1>Chienomi</h1></a></header>
      <section id="ArticleBox">
        <header id="ArticleTitle"><h1>新品コンピュータを初期状態に戻せるようにバックアップ</h1></header>
        <article id="MainArticle">
<h2 id="これは何">これは何</h2>
<p>新品コンピュータを購入したときに、完全に元の状態に復元できるようにするものである。</p>
<p>バックアップ手段は色々とあるのだが、もっとも確実かつ完全な手段が「ディスクの完全なクローンを得る」という方法だ。</p>
<p>その方法について紹介しよう。</p>
<p>なお、これは「やや複雑な手段をとっても効率的に、確実に元に戻せる手段を構築したい」という人向けであり、 そのような場合は諦めるという人や、考えたり努力することを回避したいという人は対象としていない。</p>
<h2 id="新品ならでは">新品ならでは</h2>
<p>新品のコンピュータのディスクは、ファイルをコピーしているわけではない。 データを流し込んで複製しているのだ。</p>
<p>一般的には、先頭からWindowsシステム用の領域が書き込まれ、そして末尾にバックアップ用の領域があるのが一般的である。 バックアップ用の領域はパーティションが切られ、その中に格納されていることもあるし、パーティションレイアウトの末尾の後ろに配置される場合もある。</p>
<p>このため、データが書かれているのは先頭と末尾のみで、中間は全くデータがなく、<code>0</code>が書かれている。</p>
<p>128GBのディスクをフルクローンした場合は当然ながら128GBのファイルが出来上がる。 だがしかし、連続する<code>0</code>のデータは圧縮すると極めて小さくなる。そのため、このようなディスクイメージは圧縮することによって非常にコンパクトにできるのだ。</p>
<p>これが使用していたディスクであればうまくいかない。 データが記録されていない領域も<code>0</code>で埋められているわけではなく、ごちゃごちゃに記録された状態になっているため、フルディスクイメージを圧縮したときに極端に小さくなることはない。 そのため、完全性や確実性が低下してでもなるべくコンパクトな形式でバックアップするのが一般的なアプローチになる。(partimageやntfscloneなどを使うということだ)</p>
<h2 id="書き戻しに関して">書き戻しに関して</h2>
<p>次のようにして取得したイメージは</p>
<pre><code>$ dd if=/dev/sda | xz -z -c &gt; /mnt/sda.img.xz</code></pre>
<p>次のようにして書き戻すことができるのだが</p>
<pre><code>$ xz -d -c /mnt/sda.img.xz &gt; /dev/sda</code></pre>
<p>この場合、128GBの「元のディスクに」書き戻すことを前提している。</p>
<p>サイズが違う場合どうなるかというと、ディスクが大きければパーティションがディスク全域ではなく途中で終了し、途中にリカバリー用の領域が置かれた状態になる。 ディスクが小さい場合はパーティションがディスクのサイズよりも大きく設定されてしまう。 この修正はちょっと大変だ(Windows上では難しいかもしれない)。</p>
<p>だが、実際のところリカバリー領域は書き戻しによって復元できているため、なくなってしまっても構わない、と考えられる。 そして、パーティションテーブルはパーティションの内容より前にある。 よって「先頭からデータのある分だけを復元すれば良い」ということになる。</p>
<p>このため、復元したデータは全部書く必要はなく</p>
<pre><code>$ xz -d -c /mnt/sda.img.xz | dd of=/dev/sda bs=1024M count=10</code></pre>
<p>のようにすれば良い(1024MB=1GiBを10回なので10GiB書き込むことになる)。 内容としてはどのみち残りは<code>0</code>なのであり、書いてもかかなくても同じだ。 ディスクサイズが異なる場合はパーティションサイズのみ変更すれば良い。</p>
<h2 id="バックアップの仕方">バックアップの仕方</h2>
<p>Linuxで起動する…ところまでは省略しよう。 UnetBootinなどの使用は勧めないが。</p>
<p>まずはpartedでディスクを確認しよう</p>
<pre><code>$ sudo parted -l</code></pre>
<p>これによって各ディスク名(<code>/dev/sda</code>など)を得ることができる。 ここではバックアップ対象のディスクは<code>sda</code>であるとしよう。 異なる場合は読み替えること。</p>
<h3 id="リムーバブルディスクにバックアップ">リムーバブルディスクにバックアップ</h3>
<p>モダンなLinuxシステムではリムーバブルディスクを接続すれば認識され、ファイルマネージャが起動する。</p>
<p>ファイルマネージャ上でリムーバブルディスクを開き、そこで右クリックから端末(ターミナル)を開く、とする。 そして</p>
<pre><code>$ dd if=/dev/sda bs=64M of=recover.img</code></pre>
<p>のようにする。 もし、圧縮も同時に行うのであれば</p>
<pre><code>$ dd if=/dev/sda bs=64M | xz -z -d &gt; recover.img.xz</code></pre>
<p>のようにする。時間がかかっても圧縮率を上げるのであれば</p>
<pre><code>$ dd if=/dev/sda bs=64M | xz -z -d -e -9 &gt; recover.img.xz</code></pre>
<p>とすれば良い。</p>
<p>なお、NASなどのネットワークドライブ上に保存する場合も似た手順で行うことができる。</p>
<h3 id="ネットワーク上のlinuxホストに対して行う">ネットワーク上のLinuxホストに対して行う</h3>
<p>もう、説明がいるのかどうかも怪しいが、計算機母艦となるLinuxを運用している場合は 受け取る側のLinuxホストではnetcatをインストールしておく。</p>
<p>そしてnetcatで通信を待機する。 次の例ではBSD netcatを使用する。</p>
<pre><code>$ nc -N -l 22500 &gt; recover.img</code></pre>
<p>受け取り側で圧縮する場合は次のようにする。</p>
<pre><code>$ nc -N -l 22500 | xz -z -d -e -9 &gt; recover.img.xz</code></pre>
<p>送り側はncなどはない場合が多いだろうし、ライブブートではインストールも難しい。 しかし、bashにはTCP機能があるため、これを利用する。</p>
<pre><code>$ dd if=/dev/sda bs=64M &gt; /dev/tcp/192.168.1.128/22500</code></pre>
<p>注意点は、bashでなければならないこと、そしてファイルに書けばよいわけではなくリダイレクト機能を使わなければいけないことだ。</p>

<!-- PBSEARCH_RESULT -->
        </article>
    </section>
    <footer id="InfoFooter">
      <ul>
        <li>© Masaki Haruka 2003.</li>
        <li>Generated by <a href="https://gitlab.com/reasonset/pbsimply-wpimporter">PureBuilder Simply WP Importer</a></li>
      </ul>
    </footer>
  </body>
</html>
