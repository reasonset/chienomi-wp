<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="ja" xml:lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="generator" content="PureBuilder Simply WP Importer" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
    <meta name="author" content="Masaki Haruka" />
    <meta name="date" content="2014-12-15T00:00:00+09:00" />
    <meta name="dcterms.date" content="2014-12-15T00:00:00+09:00" />
    <title>Windows TrueCrypt * Linux LUKS - Chienomi</title>
    <style type="text/css">article {
max-width: 1080px;
margin: auto;
}</style>
  </head>
  <body>

    <section id="ContentContainer">
      <header id="MainHeader"><a href="/"><h1>Chienomi</h1></a></header>
      <section id="ArticleBox">
        <header id="ArticleTitle"><h1>Windows TrueCrypt * Linux LUKS</h1></header>
        <article id="MainArticle">
<p>先に述べたように、警察は証拠捏造の上、データを全消去していたため、自衛手段としては甚だ不足ではあるものの、一応オフラインアタックに耐えるラップトップの暗号化を施すことにした。なお、デスクトップはUEFI+GPT+Windows7 Prefessionalなので、有料ソフトを使わないとできない。</p><p>構成は次のようになっていた</p><ol><li>Windows 7 Windows Reserved</li><li>MS Data(NTFS, Windows C:)</li><li>openSUSE /boot(Ext3)</li><li>Extended</li><li>openSUSE /(btrfs)</li><li>openSUSE swap</li></ol><p>ブートローダーはMBRにインストールされたGrub2だ。</p><p>Windowsの暗号化はTrueCryptを、Linuxの暗号化はLUKSを使う。なお、Linux*LUKSは/bootを暗号化できないことを理解しておく必要がある。</p><p>TrueCryptはWindows System全域の暗号化が可能でデュアルブートにも対応する。ただし、MBRにbootmgrが導入されていることを前提とするため、現在のシステムでは対応できない。どのみちLinuxはLUKSに移行するため消去されることを踏まえ、今回はデータを退避した上でopenSUSEには消えてもらう。</p><p>だが、まずbootmgrを復元するというところで苦戦した。まず、systemrescueCDのsys-msで復元を試みたが、相変わらずGrubが起動する。次にWinPE-tch DirectによるWindows PEでbootrecを試みたがコマンドがないと言われる。修復ディスクはファイルがないのでインストールディスクを入れろというがプリインストール版。結局デスクトップ用を使って作ってみたが、修復するOSのリストは空だった。調べた結果、OSを選択しないままコマンドプロンプトを起動し、次のようにすることでできた。</p><samp style="display: block;white-space: pre-wrap">&gt; diskpart
diskpart&gt; list disk
diskpart&gt; select disk 0
diskpart&gt; list partition
diskpart&gt; select partition 1
diskpart&gt; active
diskpart&gt; exit
&gt; bootrec /fixboot
&gt; bootrec /fixmbr
&gt; bcdedit
</samp><p>これでbootmgrがWindowsを起動するようになった。</p><p>Linuxは安定してうまく動いているManjaroを使いたかったのだが、Mnajaroは手動インストールだとディスクの暗号化が設定できない。構成が簡単ではないので、ローリング・リリースが望ましいとして、Sabayon Linuxを選択。Sabayon Linuxは手動パーティショニングで暗号化オプションがあり、容易に設定可能だ。また、Grubは<tt class="puredoc_pathname">/dev/sda3</tt>にインストールする。この設定もわかりやすく、よくできたインストーラだった。細かい設定は難しいが。</p><p>この状態ではLinuxはブートされないが、気にせずTrueCryptに進む。Encrypt system drive/partitionから、ウィザードに従って進むのだが、英語だ。別に英語ができないわけではない私でも、システムの消滅をかけた作業になるため、かなり神経を使った。手順を撮っておくべきだったかもしれない。ただし、ウィザードに従って進めれば良い。20文字以上のパスワードを要求したり、wipeは4回以上を要求したりと、暗号化ソフトとしてはものすごく本気だ。</p><p>途中一度再起動する。この際、作ったばかりのレスキューディスクはejectしておく。また、ディスクのverifyはWindows image burnerのverifyとは別に行うので、その時はディスクを入れてnextする必要がある。メソッドはAESを使用した。最も速かったからだ。</p><p>TrueCryptは自動でLinuxパーティションを見つけ、ブートを設定する、と説明しているサイトがあるが、実際はTrue Crypt BootLoaderがbootmgrを呼び出す。そのため、bootmgrでLinuxをブートさせなくてはいけなかった。</p><p>まず、LiveLinuxで（systemrescueCDを使用した）ブートし、<tt class="puredoc_pathname">/boot</tt>のあるデバイスの512Bをリムーバブルディスク（普通はUSBメモリーだろう）にコピーする。</p><samp style="display: block;white-space: pre-wrap"># <kbd>mount /dev/sdb1 /mnt</kbd>
# <kbd>dd if=/dev/sda3 of=/mnt/linux.pbr count=1 bs=512</kbd>
</samp><p>再起動してWindowsに。ディスクからpbrファイルをCドライブ直下に配置する。</p><p>あとは次のようにする。</p><samp style="display: block;white-space: pre-wrap">&gt; <kbd>bcdedit /create /d "<var>Ubuntu</var>" /application bootsector</kbd>
エントリ {<var>GUID</var>} は正常に作成されました。
&gt; <kbd>bcdedit /set {<var>GUID</var>} device partition=C:</kbd>
操作は正常に終了しました。 
&gt; <kbd>bcdedit /set {<var>GUID</var>} path \ubuntu.pbr</kbd>
操作は正常に終了しました。 
&gt; <kbd>bcdedit /displayorder {<var>GUID</var>} /addlast</kbd>
操作は正常に終了しました。
</samp><p>一瞬でブートされてしまうので、コントロールパネル→システム→システム詳細→起動と回復から規定のシステムの選択とデフォルトブート時間の設定。</p><p>以上でうまくいった。</p><p>Sabayonは非常に美しく、優れたエクスペリエンスを持っている。Gentooベースだが、かなりがんばっているようだ。英語だが、rigoの選択肢が凝っていて、普通の二択よりもはっきりと判断できるのも良い。</p><p>なお、Linuxブート時はパスフレーズは2回入力することになる。Grubパスワードも設定していると3回だ。20文字以上を設定していると結構大変なので、それなりに覚悟はしておいてほしい。また、当然ながらパフォーマンスは低下する。DTM専用のデスクトップでは、多分厳しい。</p>
<!-- PBSEARCH_RESULT -->
        </article>
    </section>
    <footer id="InfoFooter">
      <ul>
        <li>© Masaki Haruka 2003.</li>
        <li>Generated by <a href="https://gitlab.com/reasonset/pbsimply-wpimporter">PureBuilder Simply WP Importer</a></li>
      </ul>
    </footer>
  </body>
</html>
