<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="ja" xml:lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="generator" content="PureBuilder Simply WP Importer" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
    <meta name="author" content="Masaki Haruka" />
    <meta name="date" content="2019-03-09T00:00:00+09:00" />
    <meta name="dcterms.date" content="2019-03-09T00:00:00+09:00" />
    <title>不安定なホスト(非固定IPアドレス, 非常時稼働)をサーバーにする - Chienomi</title>
    <style type="text/css">article {
max-width: 1080px;
margin: auto;
}</style>
  </head>
  <body>

    <section id="ContentContainer">
      <header id="MainHeader"><a href="/"><h1>Chienomi</h1></a></header>
      <section id="ArticleBox">
        <header id="ArticleTitle"><h1>不安定なホスト(非固定IPアドレス, 非常時稼働)をサーバーにする</h1></header>
        <article id="MainArticle">
<h2 id="序">序</h2>
<p>需要があるらしいので、この話。</p>
<p>不安定なホスト(非固定IPアドレス―浮動IPアドレス, ステートフルIPアドレス, あるいは間違っているけれど可変IPアドレス― または 非常時稼働システム)をサーバーにする、というテーマで、 方法はたくさんあるのだが、私の結論は「商業レベルでやることではない」である。</p>
<h2 id="待ち受ける">待ち受ける</h2>
<h3 id="ddns">DDNS</h3>
<p>最も普通の方法だが、実際にはかなり制約が多い。</p>
<p>SFPレコードは効かないし、DNSレコードは反映をコントロールできない<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a>ので逆引きが効かなかったりでサーバーとしては結構痛いことになる。</p>
<h3 id="リバースフォワーディング">リバースフォワーディング</h3>
<p>これはかなり簡単な方法で、例えば次のようにする。</p>
<pre><code># ssh -g -R 80:localhost:80 serverhost</code></pre>
<p>これによってインターネットから安定して接続できるホストに代理ホストとして公開してもらう。</p>
<p>不安定なホストの非稼働時は代理ホストが応答する。</p>
<h3 id="フロントエンドプロキシ">フロントエンドプロキシ</h3>
<p>リバースフォワーディングと同様に代理ホストに公開してもらうのだが、不安定なホストに通信を転送させるのではなく、中継させるという方法。</p>
<p>まずなんらかの方法で代理ホストと不安定なホストを接続する。 例えばVPNで接続する。</p>
<pre><code># pppd updetach noauth silent nodeflate pty &quot;ssh root@remote-gw /usr/sbin/pppd nodetach notty noauth&quot; ipparam vpn 10.0.8.1:10.0.8.2</code></pre>
<p>あるいはSSHによる転送を行う。</p>
<pre><code>$ ssh -R 8080:localhost:80</code></pre>
<p>そして、代理ホスト上でリバースプロキシを動作させる。例えばSquidやNginxをプロキシとして、ローカルネットワークホストとして、あるいはローカルホストの別ポートとして転送する。</p>
<p>VPNで接続している場合、代理ホストからは不安定なホストは不安定なグローバルIPアドレスではなくローカルなIPアドレス<code>10.0.8.1</code>として認識される。</p>
<p>不安定なホストの非稼働時は代理ホストが応答する。</p>
<h3 id="逆接続モデル">逆接続モデル</h3>
<p>利用可能なサーバーが限定されてしまうが、サーバーからクライアントに接続するモデルがとれるのであれば、不安定なホストであることはあまり問題にならない。 あるいはサーバーリレーするタイプ(送信専用メールサーバーなど)でも機能する。</p>
<h3 id="vpnで接続する">VPNで接続する</h3>
<p>インターネット公開しているのでないのならば、代理ホストを経由するなどしてVPNで接続し、ローカルなアドレスを代わりに使うという方法が効く。</p>
<h3 id="非ip">非IP</h3>
<p>「IPアドレスが固定でない」ことはIPアドレスを用いる場合にのみ問題として発生する。 だったらIP以外で通信すれば良い。</p>
<p>ただし、この場合はほとんどローカルなIPアドレスで運用する方法も適用できる(VPNで接続するなど)ことになるし、 リンクローカルな通信であることがほとんどだから、これを転送するハードルを考えるとあまり易しくはない。</p>
<p>例えばセキュリティの都合上でIP接続を許可していないAoEサーバー、なんていうのはアリだ。</p>
<h3 id="zeroconf">Zeroconf</h3>
<p>リンクローカルでIPアドレスが固定でないことを考慮しなければならないケースはあまり見当たらないが、 リンクローカルなのであればZeroconfが使える。</p>
<h2 id="ipアドレス制限されたホストに接続する">IPアドレス制限されたホストに接続する</h2>
<h3 id="レンジで許可する">レンジで許可する</h3>
<p>ステートフルに割り振られるIPアドレスのレンジが十分に制限されているのであれば範囲で許可すれば良い。</p>
<h3 id="ゲートウェイ経由">ゲートウェイ経由</h3>
<p>固定IPアドレスを持つホストを経由して接続する。</p>
<p>SSHならば割と簡単にできる。</p>
<pre><code>$ ssh -L 10000:destination.example.com:10000 proxyhost</code></pre>
<p>VPNで代理ホストを経由しても良い。</p>
<h3 id="別の方法で接続する">別の方法で接続する</h3>
<p>例えばSSHやVPNなど特定のポートだけIPアドレス制限の対象外とした上で、これらのセキュアトンネルを通じて接続する。</p>
<p>MySQLサーバー等、認証が強力でないサービスのためにIPアドレス制限がなされているのであれば、SSHのように認証が強力な方法についてはIPアドレス制限から除外し、これを経由することを許す、というわけである。</p>
<h3 id="許可されているホストに依頼する">許可されているホストに依頼する</h3>
<p>ゲートウェイ接続はできないまでも融通の効くホストで接続が許可されているホストがあるのであれば、これをプロキシとして接続する。</p>
<p>このような場合普通はアプリケーションプロキシとして使うか、SOCKSプロキシとして使うものだ。 このプロキシに対する接続に認証を求めるべきで、異なる方法で安全性を担保させるわけである。</p>
<h2 id="ちなみに以前紹介したsshフォワーディングの場合">ちなみに、以前紹介したSSHフォワーディングの場合</h2>
<ol type="1">
<li>ローカルなポートフォワーディングにより代理ホストから不安定なホストに通信を中継するようにする。 (これ自体は公開されていない)</li>
<li>プロキシコマンドとして外部ホストから代理ホストに対して接続を行う</li>
<li>これによって確立された経路を使って代理ホストのlocalhost(lo)に対してSSHを通す (これがダイナミックポートフォワーディングによって不安定なホストに転送される)</li>
</ol>
<p>という方法で、計3本のトンネルが通されることになる。</p>
<section class="footnotes">
<hr />
<ol>
<li id="fn1"><p>「TTLに従う」と信じているなら、ちょっとハッピーすぎる。<a href="#fnref1" class="footnote-back">&#x21a9;</a></p></li>
</ol>
</section>

<!-- PBSEARCH_RESULT -->
        </article>
    </section>
    <footer id="InfoFooter">
      <ul>
        <li>© Masaki Haruka 2003.</li>
        <li>Generated by <a href="https://gitlab.com/reasonset/pbsimply-wpimporter">PureBuilder Simply WP Importer</a></li>
      </ul>
    </footer>
  </body>
</html>
