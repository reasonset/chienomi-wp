<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="ja" xml:lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="generator" content="PureBuilder Simply WP Importer" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
    <meta name="author" content="Masaki Haruka" />
    <meta name="date" content="2015-10-03T00:00:00+09:00" />
    <meta name="dcterms.date" content="2015-10-03T00:00:00+09:00" />
    <title>携帯万能の「送信メールが取り込めない」問題をなんとかする - Chienomi</title>
    <style type="text/css">article {
max-width: 1080px;
margin: auto;
}</style>
  </head>
  <body>

    <section id="ContentContainer">
      <header id="MainHeader"><a href="/"><h1>Chienomi</h1></a></header>
      <section id="ArticleBox">
        <header id="ArticleTitle"><h1>携帯万能の「送信メールが取り込めない」問題をなんとかする</h1></header>
        <article id="MainArticle">

<p>私はWILLCOMのW11Kを使っているのだが、このメールデータを取り込むのに、「携帯万能」以外の道がない。</p>

<p>そのため、Amazonで携帯万能を購入して使っているのだが（昨日のエントリの通り）、これがまた曲者で、対応するドライバがWindows 2000/XP/Vista/7の<em>32bitのみ</em>という。</p>

<p>Windows 8でもWindows 7 64bitでもダメというのは、今時相当きつい。
うちではWindows XPマシンが1台あるだけだ。</p>

<p>さて、Windows XPはトリスターサポートの「まっさらにしろ」という指示により苦労しつつも初期化したのだが、取り込んだところ結局同じ問題だ。
送信メールが正常に取り込めない。</p>

<p>トリスターの人は、Outlookがどうとか、全く違うところに話を持って行ってしまうのだが、明らかに「アップデータでバグを埋め込んだ」話だ。</p>

<p>で、エクスポートしたCSVを実際に見てみた。</p>

<p><code>lv</code>で見てみると、ある時期を境に文字化けが分かれている。これはまぁ、わかる。
そして、Mousepadで開こうとすると、不正なシーケンスがあるとして開けない。</p>

<p>Shift-JISならShift-JISで開けるソフトなので、これは恐らく違う文字エンコーディングがバイト列をそのままに吐き出している、ということだろう。
だとしたら、まだ手はある。</p>

<p>試しに、<code>head</code>と<code>tail</code>と<code>cut</code>で文字化けしているところとしていないところだけを切り出してnkf -gしてみると</p>

<pre><code>$ tail send-text.csv | cut -f 5 -d "," | nkf -g
Shift_JIS
$ head send-text.csv | tail -n 9 | cut -f 5 -d "," | nkf -g
UTF-8
$ head send-text.csv | cut -f 4 -d "," | nkf -g
Shift_JIS
</code></pre>

<p>やっぱり</p>

<ul>
  <li>以前は全てShift-JISだった</li>
  <li>現在は、Subjectまでの4フィールドはShift-JISだが、本文だけUTF-8である</li>
</ul>

<p>ということが分かった。</p>

<p>さすがにこの混在はきついので、分離する。</p>

<pre><code>$ head -n 3825 send-text.csv &gt;| sendmail-UTF8sec.csv
$ head -n+3826 send-text.csv &gt;| sendmail-SJISsec.csv
</code></pre>

<p>通常は後半部分は考えなくていいはずだ。
後半部分は単に結合すれば良いように変換しておく。</p>

<pre><code>$ nkf -w -Lu sendmail-SJISsec.csv sendmail-SJISsec.utf8.csv
</code></pre>

<p>で、困ったことにこの状態だとRubyでCSVを切り出すことができない。RegExpが使えないために、<code>CSV</code>ライブラリも使えないのだ。</p>

<p>Perlで試したところ</p>

<ul>
  <li><code>perl -n</code>なら黙っていてもできる</li>
  <li><code>while (&lt;&gt;)</code>だと<code>use utf8</code>の必要あり</li>
</ul>

<p>というわけで、結局こういうコードになった。</p>

<pre><code>#!/usr/bin/zsh

head -n1 "$1" | nkf -w -Lu &gt;| out.csv

tail -n+2 "$1" | perl -n -e 'if ($_ =~ /"(?:[^"]*|"")*"\s*$/) { print STDOUT $&amp;; print STDERR $`; print STDERR "\n" }' &gt;| out.l 2&gt;| out.f
nkf -w -Lu out.l &gt; out.lu
nkf -w -Lu out.f &gt; out.fu

ruby -e 'File.foreach(ARGV[0]).zip(File.foreach(ARGV[1])) {|i,j| puts(i.chomp + "," + j) }' out.fu out.lu | sort -u &gt;&gt; out.csv
</code></pre>

<p>単純に<code>,</code>で区切るとエンベロープやSubjectに入っている可能性があるため、せめてこうした。多分これでいけるはずだ。</p>

<p>一時ファイルなしでいきたかったが、そうするとnkfから1行ずつ読む必要があり、ちょっと面倒だった。</p>

<p>ちなみに、これ</p>

<ul>
  <li>1行目はCSVヘッダーでShift-JIS</li>
  <li>sortしている関係で日付順になる。<code>sort -ru</code>にすればオリジナルと同じ配列</li>
</ul>

<p>この状態だとまともなCSVなので、MHやemlに変換するのも、それほど難しくない。</p>

<p>ほんとにひどい品質のソフトだと思う。</p>

<!-- PBSEARCH_RESULT -->
        </article>
    </section>
    <footer id="InfoFooter">
      <ul>
        <li>© Masaki Haruka 2003.</li>
        <li>Generated by <a href="https://gitlab.com/reasonset/pbsimply-wpimporter">PureBuilder Simply WP Importer</a></li>
      </ul>
    </footer>
  </body>
</html>
