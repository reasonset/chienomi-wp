<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="ja" xml:lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="generator" content="PureBuilder Simply WP Importer" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
    <meta name="author" content="Masaki Haruka" />
    <meta name="date" content="2019-01-24T00:00:00+09:00" />
    <meta name="dcterms.date" content="2019-01-24T00:00:00+09:00" />
    <title>ReadyNasでSFTPしたい - Chienomi</title>
    <style type="text/css">article {
max-width: 1080px;
margin: auto;
}</style>
  </head>
  <body>

    <section id="ContentContainer">
      <header id="MainHeader"><a href="/"><h1>Chienomi</h1></a></header>
      <section id="ArticleBox">
        <header id="ArticleTitle"><h1>ReadyNasでSFTPしたい</h1></header>
        <article id="MainArticle">
<h2 id="概要">概要</h2>
<p>ReadyNASは、だいたいNTT-X Storeのメルマガで嫌というほど見ているNASだと思うが、NAS製品ではちょっと安めで定番である。</p>
<p>機能的にも充実していて使えるNASなのだが、ちょっと弱点がある。 それは、「iSCSI LUNにディスク全体の90%しか割り当てられない」ことだ。 どうも、90%以上ディスクを使わせないという考えかららしいのだが、はっきりいって10%もデッドにされるのは無駄である。</p>
<p>仕方ないので残り10%(3Tくらいはある)をなんとか使いたいのだが、そうなると共有ドライブということになるだろう。 まぁ、iSCSIボリューム以外に共有しない形で存在するディスクがあるとそれはそれで便利でもある。</p>
<p>しかし、その選択肢は、SMB, NFS, AFP, FTP, HTTP…</p>
<p>SFTPがない。 せっかくディスクの暗号化をしているのに、さすがに共有ディスクがネットワークから丸見えではお話にならない。 やはりSFTPがなくてはならないだろう。SFTPが使えればNemoやSSHFSも使えるし。</p>
<p>そこでReadyNASでSFTPを使えるようにする。 普段LinuxやSSHをよく使っている人には目新しさのないお話だ。</p>
<h2 id="具体的手順">具体的手順</h2>
<h3 id="sshdを有効にする">SSHDを有効にする</h3>
<p>システム → 設定 → SSHで有効にする。 「SSHを有効にする」にチェックを入れて適用するだけで良い。 警告が出るが、続行する。</p>
<h3 id="鍵を作る">鍵を作る</h3>
<p><code>ssh-keygen -f ~/.ssh/readynas_rsa</code>という感じでいいだろう。</p>
<h3 id="アカウントを用意する">アカウントを用意する</h3>
<p>アカウント → ユーザー → 新しいユーザー でユーザーを作る。 特にNFSを使う気がないのならUIDはそれほど気にする必要はないだろう。</p>
<p>ユーザーを作ったらユーザーを選択し、設定からSSHタブを選択。 「シェルアクセスを許可」にチェックを入れ、「公開キーのインポート」で<code>readynas_rsa.pub</code>をアップロードする。 このとき、「rsyncのみ」のチェックを外すこと。</p>
<h3 id="ログインして設定">ログインして設定</h3>
<p>これでログインできるようになった。</p>
<p>コントロールパネルから設定した鍵は<code>~/.ssh/ssh_authorized_keys</code>に入るようになっているが、このファイルは書き込みできず、<code>~/ssh_authorized_keys</code>も有効である。 そこで、もう1ペア鍵を作り、</p>
<pre><code>$ scp -i ~/.ssh/readynas_rsa ~/.ssh/readynas_sftp_rsa.pub user@readynas:.ssh/authorized_keys</code></pre>
<p>のようにコピーするのだが、その前にコピー元のファイルで<code>command="internal-sftp"</code>を手前に追加しておくといいだろう。</p>
<h3 id="これでsftpの準備は完了">これでSFTPの準備は完了</h3>
<p><code>~/.ssh/config</code>に記述しておけば簡単にSFTPアクセスができるようになった。 非常に柔軟に扱うことができてとても良い。</p>
<p>なお、ルートディレクトリを除くとどれがドライブディレクトリかはすぐ分かると思うが、<code>/home</code>もディスクアレイのbtrfsがマウントされている。 ドライブディレクトリ以下にも<code>home</code>というディレクトリがあるけれど、これは「共有」にある「ホーム」にあたるもので、別にホームディレクトリに直接ファイルを配置しても問題はなさそうだ。</p>
<p>なにはともあれ、とても使いやすくなってバンザイ。</p>

<!-- PBSEARCH_RESULT -->
        </article>
    </section>
    <footer id="InfoFooter">
      <ul>
        <li>© Masaki Haruka 2003.</li>
        <li>Generated by <a href="https://gitlab.com/reasonset/pbsimply-wpimporter">PureBuilder Simply WP Importer</a></li>
      </ul>
    </footer>
  </body>
</html>
