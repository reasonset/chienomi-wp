<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="ja" xml:lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="generator" content="PureBuilder Simply WP Importer" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
    <meta name="author" content="Masaki Haruka" />
    <meta name="date" content="2015-02-18T00:00:00+09:00" />
    <meta name="dcterms.date" content="2015-02-18T00:00:00+09:00" />
    <title>ストレージワーク:btrfs+EncFS / dm-crypt+ZFSでのリモートミラー - Chienomi</title>
    <style type="text/css">article {
max-width: 1080px;
margin: auto;
}</style>
  </head>
  <body>

    <section id="ContentContainer">
      <header id="MainHeader"><a href="/"><h1>Chienomi</h1></a></header>
      <section id="ArticleBox">
        <header id="ArticleTitle"><h1>ストレージワーク:btrfs+EncFS / dm-crypt+ZFSでのリモートミラー</h1></header>
        <article id="MainArticle">

	<p>Btrfs上にEncFSを構成したマスターから、dm-crypt上にZFSを構築したスレーブへとミラーする、しかもそれらのホストはシャットダウンされる。これはかなり厳しい条件だった。</p>
	<p>やはりシャットダウンされるためにHA（高可用）システムは使えない。シャットダウンする時点で障害発生とみなされるし、切り離された状態で単独でスタートアップして動けない。</p>
	<p>さらに、EncFSはrootであってもアクセスを許さないため、非常にセキュアではあるが、GlusterFS GeoReplicationも使えないなど障害になった。</p>
	<p>やはり無理な要求である、というのは
		<a href="http://www.linuxquestions.org/questions/showthread.php?p=5318521#post5318521" alt="LinuxQuestionで聞いてみても">
LinuxQuestionで聞いてみても
		</a>明らかになるだけだった。だが、ここでrsyncが大規模システムに耐えるということが分かったため、<span style="font_style: italic;">rsync(1)</span>と<span style="font_style: italic;">at(1)</span>でいこうと決意を固めることができた。</p>
	<p>rsync+sshはごくごく単純だ。</p>
	<samp style="display: block;white-space: pre;max-width: 80%;margin: auto;overflow: scroll">rsync -e ssh <var>fromdir</var> <var>user</var>@<var>host</var>:<var>destdir</var></samp>
	<p>でいける。だが、まずはZeroconfでアクセスしたい。</p>
	<p>Manjaroで<tt class="puredoc_pathname">/etc/nsswitch.conf</tt>に<tt class="puredoc_value">mdns_minimal</tt>を指定しても解決できない。これでホスト名を解決しようと思うと、<tt class="puredoc_value">nss-mdns</tt>パッケージをインストールし、<tt class="puredoc_value">avahi-daemon</tt>を動かさなくてはいけない。</p>
	<p>さらに、CentOS側が受け入れてくれない。これは、NICがひとつだとそのNICをpublicなゾーンのインターフェイスとみなすが、Avahiはhomeインターフェイスにしか許されていない。そのため、<code>firewall-cmd --add-service=avahi --zone=public --permanent</code>としてAvahi-daemonへのアクセスを透過する。</p>
	<p>これでZeroconfでのアクセスに成功、<tt class="puredoc_value">.local</tt>のホスト名でsshアクセスできる。<tt class="puredoc_cmdname">ssh-keygen</tt>でパスフレーズなしのキーを作り、アクセスしようとする。ところが、<tt class="puredoc_cmdname">ssh-copy-id</tt>しようとした段階で<samp>Too many authentication failures for ...</samp>となり、sshアクセスできない。これは、sshの管理下にある鍵が多すぎる場合に生じるようだ。その数はsshdが登録、管理している鍵とファイルとして<tt class="puredoc_pathname">~/.ssh</tt>以下にある鍵の総数。とりあえずの方法としては、鍵ファイルがあるものだけを鍵として扱うため、<tt class="puredoc_pathname">~/.ssh/config</tt>に</p>
	<samp style="display: block;white-space: pre;max-width: 80%;margin: auto;overflow: scroll" ="filecontent">IdentitiesOnly yes
	</samp>
	<p>と書くと改善される。ただし、ファイル自体が多くなるとこれでもダメだろう。</p>
	<p>これで鍵によるアクセスまでできるようになった。</p>
	<p>鍵による実際のアクセスの前に、atとrsyncについて確認する。rsyncについては前述の通りで大丈夫。atは</p>
	<samp style="display: block;white-space: pre;max-width: 80%;margin: auto;overflow: scroll" ="shell">$ &lt;kbd&gt;at now + 1 minutes &amp;lt;&amp;lt;&amp;lt; 'zsh -c &quot;notify-send \&quot;$(id)\&quot;&quot;'&lt;/kbd&gt;
	</samp>
	<p>すると自身のuidになっているので、atを実行したユーザーで実行されることが分かる。EncFSに対してアクセスするためにはこれは絶対条件だ。</p>
	<p>そしてこのままrsyncするとうまくいく。だが、パスフレーズなしで自由にアクセスできる鍵というのは危険だ。</p>
	<p>コマンドで制限すべきなのだが、rsyncのコマンドを受ける側がどうなっているのか、というのは非常にわかりにくい。<tt class="puredoc_cmdname">rsync -vvv -au --delete-after -e ssh <var>from</var> <var>dest</var></tt>して、パスワードの前に表示されたconnectionの中からrsyncより前を削り、互いにvを削って設定する。</p>
	<p>ただし、このままでは外部からファイルを消されるリスクがあるため、ホストも限定したほうがいいかもしれない。ただし、鍵がなければできないのだから、その時はバックアップ側は仕方がない、とも見れる。</p>
	<p>今回の成果物も
		<a href="https://github.com/reasonset/rsoftmirror" alt="GitHub">
GitHub
		</a>にて公開。</p>
<!-- PBSEARCH_RESULT -->
        </article>
    </section>
    <footer id="InfoFooter">
      <ul>
        <li>© Masaki Haruka 2003.</li>
        <li>Generated by <a href="https://gitlab.com/reasonset/pbsimply-wpimporter">PureBuilder Simply WP Importer</a></li>
      </ul>
    </footer>
  </body>
</html>
