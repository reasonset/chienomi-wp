<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="ja" xml:lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="generator" content="PureBuilder Simply WP Importer" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
    <meta name="author" content="Masaki Haruka" />
    <meta name="date" content="2018-10-20T00:00:00+09:00" />
    <meta name="dcterms.date" content="2018-10-20T00:00:00+09:00" />
    <title>Systemdがserviceプロセス終了時にstopするのは正しいか - Chienomi</title>
    <style type="text/css">article {
max-width: 1080px;
margin: auto;
}</style>
  </head>
  <body>

    <section id="ContentContainer">
      <header id="MainHeader"><a href="/"><h1>Chienomi</h1></a></header>
      <section id="ArticleBox">
        <header id="ArticleTitle"><h1>Systemdがserviceプロセス終了時にstopするのは正しいか</h1></header>
        <article id="MainArticle">
<p>Systemdユニットで<code>ExecStop</code>を書いたのが初めてだったのだけれど、どうしても<code>ExecStop</code>を書くと<code>Type</code>によらず<code>stop</code>されてしまう。</p>
<p><code>Type</code>が<code>oneshot</code>であるならばこれは正しい。 <code>Type=oneshot</code>である場合、<code>.service</code>ユニット起動時に<code>ExecStart</code>を実行し、この終了を待つ。 <code>ExecStart</code>プロセスの実行中はactiveとなり、実行が終了するとサービスそのものが終了したとみなし、inactiveになる。</p>
<p>Systemdユニットに詳しい人は割と少ないのでサービスタイプについて改めて解説しておこう。</p>
<p><code>oneshot</code>は単純にその時に実行するだけのサービスである。 起動は実行終了を待ち、終了したらサービス自体を終了する。</p>
<p><code>simple</code>はデフォルトのサービスタイプである。 このサービスタイプはプロセスを実行していることで機能するサービスである。 フォアグラウンドで実行を継続するタイプのサービスに対して適用し、起動時は実行すると起動完了とみなす。<code>oneshot</code>のように起動したプロセスの実行中がactiveとなる。</p>
<p><code>forking</code>はoneshotのようにサービスの実行終了を待つが、ステータスは直接実行したプロセス(<code>$MAINPID</code>)だけでなく、その子プロセスで判断する。 これは実行するのがサービスそのものではなく、起動スクリプトである場合に有用である。</p>
<p>さぁ、ここまではいい。 問題は、<code>ExecStop</code>がいつ実行されるのか、である。</p>
<p>普通に考えれば<code>systemctl stop foo.service</code>したときに実行されるものだろう。 ところが実際は「サービスが終了した場合にも実行される」。 これは<code>ExecStopPost</code>と同じだ。</p>
<p>だが、そうでないケース(今回の場合は、iscsiターゲットにログインし、ファイルシステムをマウントする)は困ってしまう。 このようなケースにおいてはiscsiターゲットログインとファイルシステムマウントをそれぞれ別のユニットとして管理するという方法もあるが、いずれにせよ「実行時に終わっては困る」のである。 このようなケースにおいてはTypeとして<code>oneshot</code>を指定した上で<code>RemainAfterExit=true</code>とすることで目的を達することができる。 これにより、実行が終了した(起動したプロセスが終了した)場合でも実行ステータスは実行中になる。</p>
<p>つまり、<code>ExecStop</code>というのは、「サービスを停止する」のではなく「サービスプロセスのガベージコレクション」なのだ。</p>
<p><code>RemainAfterExit=true</code>は基本的に<code>oneshot</code>と組み合わせる前提になっている。 <code>simple</code>や<code>forking</code>でも作用するが、マニュアルには<code>oneshot</code>前提で書かれている。 つまりSystemdが起動したプロセスが終了してもサービスは有効な状態になっているようなスクリプトは<code>oneshot</code>であるべきだと考えられているのだろう。</p>
<p>だが、これは適切なのだろうか? 確かに、実行終了してもactiveな状態になっているようなものは<code>simple</code>の「サービスを提供するために実行しつづける」には該当しないし、<code>forking</code>の「子プロセスがサービスとして機能する」である必然性もない。 だから<code>oneshot</code>だけの例外的な振舞いだと考えていいように思われるが、それでも「サービス終了時に明示的にstopしてしまう」のであれば<code>RemainAfterExit=false</code>がデフォルトであることには違和感がある。</p>
<p>それ以上に「<code>ExecStop</code>は明示的に停止された場合にのみ実行する」オプションがないのは問題ではないのか。 <code>OnSuccess</code>や<code>OnFailre</code>はあるが、「明示的に指定された場合のみ実行したい」という希望には沿わない。 (あるいは、存在するが私が見つけられないのだろうか)</p>
<p>むしろ「<code>OnSuccess</code>や<code>OnFailre</code>があるのだから、<code>ExecStop</code>は明示的停止した場合にのみ実行したい」というのが自然なように思うのだが…</p>

<!-- PBSEARCH_RESULT -->
        </article>
    </section>
    <footer id="InfoFooter">
      <ul>
        <li>© Masaki Haruka 2003.</li>
        <li>Generated by <a href="https://gitlab.com/reasonset/pbsimply-wpimporter">PureBuilder Simply WP Importer</a></li>
      </ul>
    </footer>
  </body>
</html>
