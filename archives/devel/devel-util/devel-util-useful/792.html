<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="ja" xml:lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="generator" content="PureBuilder Simply WP Importer" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
    <meta name="author" content="Masaki Haruka" />
    <meta name="date" content="2015-11-09T00:00:00+09:00" />
    <meta name="dcterms.date" content="2015-11-09T00:00:00+09:00" />
    <title>暗号化ディスクをsystemdでがんばる - Chienomi</title>
    <style type="text/css">article {
max-width: 1080px;
margin: auto;
}</style>
  </head>
  <body>

    <section id="ContentContainer">
      <header id="MainHeader"><a href="/"><h1>Chienomi</h1></a></header>
      <section id="ArticleBox">
        <header id="ArticleTitle"><h1>暗号化ディスクをsystemdでがんばる</h1></header>
        <article id="MainArticle">

<p>これまで単純にスクリプトで暗号化ディスクをマウントしていた。
systemdスクリプトにするのは簡単で、実際にSystemdで自動マウントしていた時期もある。</p>

<p>だが、今回は「ちゃんと」Systemdを使うことにした。</p>

<p>スクリプトは<a href="https://github.com/reasonset/volumepool-decrypt">GitHub</a>で公開している。</p>

<p>私の場合、btrfsのボリュームとして4つのデバイスを使い、その4つのデバイスはディスク全体をdm-crypt plainで暗号化したものだ。
つまり、おおまかには<code>crpytsetup</code>のあと<code>mount</code>する必要があり、かつ<code>cryptsetup</code>は全ディスク分ループしなくてはいけない。</p>

<p>これ自体はスクリプトとして用意してあり、これまでそれを使っていた。
Systemd対応にするのも、単純にSystemd経由にするだけなら、以前のエントリの通り簡単なユニットで良い。</p>

<p>今回はスクリプトは、「後処理」に対応した。
もちろん、スクリプトに後処理を組み込むなら非常に簡単な話だ。
だが、それでは「後処理に失敗するとユニット全体が失敗」してしまう。
そこで、systemdの<code>ExecStartPost</code>を使うことにした。
それに伴って、スクリプトは起動スクリプトらしくなったし、設定ファイルを使うようになったりしている。</p>

<pre><code>elif [[ "$1" == post ]]
then
  ### StartPost
  if whence -f opendisk_after &gt;&amp;2
  then
	opendisk_after
  else
	exit 0
  fi

fi
</code></pre>

<p>これでだいぶ整った。これを呼ぶほうは</p>

<pre><code>ExecStartPost=/usr/local/sbin/opencryptdisk.zsh post /etc/opencryptdisk/%I.conf
</code></pre>

<p><code>%I</code>については後ほど説明。</p>

<p>しかしここでだいぶ躓いた。<code>ExecStart</code>の完了を待たずに<code>ExecStartPost</code>してしまうため、ここに処理が入っているとコケるのだ。</p>

<p>これは、<code>Type</code>を省略していると<code>simple</code>として扱われる。これは、フォアグラウンドで走るデーモンのためのユニットタイプで、「実行と同時に起動完了・実行終了とみなす」というもの。
実際はスクリプトの実行が終わった時に起動完了・実行終了としてほしいため、</p>

<pre><code>Type=oneshot
</code></pre>

<p>を追加した。</p>

<p>同じような理由で<code>ExecStop</code>が入っているとこけていたため、スクリプトにはcloseも入っているが、<code>ExecStop</code>が外されている。
<code>ExecStop</code>でアンマウントするのであれば、</p>

<pre><code>RemainAfterExit=yes
</code></pre>

<p>として、「スクリプト終了時に起動完了・実行は継続とみなす」にする必要がある。
ただ、マウントと暗号化デバイスは、多分終了時に自動的にうまくやってくれるため、必要ないと判断して外してある。</p>

<p>systemdユニットが<code>name@.service</code>の形になっていると、<code>name@param.service</code>として起動することができ、<code>@param</code>をユニット内で%Iとして使うことができる。
複数ボリュームのマウントを可能にするため、この機能を使用している。</p>

<hr />

<p>Systemdについてだが、非常に高機能だが、一方で複雑でめんどくさい。</p>

<p>例えば、マウントもスクリプト内でやるのではなく、<code>.mount</code>ユニットにして、その<code>After</code>で復号化してから実行、という形もとれたが、明らかにmountを書くほうが早い。</p>

<p>やはりかなりの暗黒面だ。</p>

<!-- PBSEARCH_RESULT -->
        </article>
    </section>
    <footer id="InfoFooter">
      <ul>
        <li>© Masaki Haruka 2003.</li>
        <li>Generated by <a href="https://gitlab.com/reasonset/pbsimply-wpimporter">PureBuilder Simply WP Importer</a></li>
      </ul>
    </footer>
  </body>
</html>
