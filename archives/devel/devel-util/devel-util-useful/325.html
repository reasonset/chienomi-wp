<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="ja" xml:lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="generator" content="PureBuilder Simply WP Importer" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
    <meta name="author" content="Masaki Haruka" />
    <meta name="date" content="2014-10-21T00:00:00+09:00" />
    <meta name="dcterms.date" content="2014-10-21T00:00:00+09:00" />
    <title>PureDocのエスケープ機能 - Chienomi</title>
    <style type="text/css">article {
max-width: 1080px;
margin: auto;
}</style>
  </head>
  <body>

    <section id="ContentContainer">
      <header id="MainHeader"><a href="/"><h1>Chienomi</h1></a></header>
      <section id="ArticleBox">
        <header id="ArticleTitle"><h1>PureDocのエスケープ機能</h1></header>
        <article id="MainArticle">
<p>ずっと機能しない、と言ってきたPureDoc組み込みHTMLエスケープ機能だが、修正されて動くようになった。</p><p>問題のコードはこんな感じ。</p><code style="display: block;white-space: pre-wrap">  STANDARD_ESCAPE_EX = /&lt;(?![a-z/])|(?&lt;![/&quot;a-z])&gt;|&amp;(?![a-z0-9]+;|#[x0-9]+;)/
  FORCE_ESCAPE_EX = /[&lt;&gt;&quot;&amp;]/
  ESCAPE_INVOKE = -&gt;(m, ptn) {
    return &quot;&quot; if m.nil?
    m.gsubz(ptn) do
      case m
      when &quot;&lt;&quot;
	&quot;&amp;lt;&quot;
      when &quot;&gt;&quot;
	&quot;&amp;gt;&quot;
      when '&quot;'
       &quot;&amp;quot;&quot;
      when &quot;&amp;&quot;
	&quot;&amp;amp;&quot;
      end
    end
  }
</code><p>修正版はこうなった</p><code style="display: block;white-space: pre-wrap">  STANDARD_ESCAPE_EX = /&lt;(?:(?:/[a-z]+|[a-z]+(?: +[a-z]+=&quot;[^&quot;]*&quot;+)*)&gt;)?|(?:&lt;(?:/[a-z]+|[a-z]+(?: +[a-z]+=&quot;[^&quot;]*&quot;+)*))?&gt;|&amp;(?![a-z0-9]+;|#[x0-9]+;)/
  FORCE_ESCAPE_EX = /[&lt;&gt;&quot;&amp;]/
  ESCAPE_INVOKE = -&gt;(m, ptn) {
    return &quot;&quot; if m.nil?
    m.gsub(ptn) do
      case $&amp;
      when &quot;&lt;&quot;
	&quot;&amp;lt;&quot;
      when &quot;&gt;&quot;
	&quot;&amp;gt;&quot;
      when '&quot;'
       &quot;&amp;quot;&quot;
      when &quot;&amp;&quot;
	&quot;&amp;amp;&quot;
      else 
        $&amp;
      end
    end
  }
</code><p>動かない原因は、<tt class="puredoc_idname">case</tt>でマッチする文字列が、正規表現のマッチ文字列ではなく元文字列になっていた、という単純なもので、気付くまでにデバッグに時間がかかったが、気付いてしまえばあっという間だった。</p><p>ところが、よく見ると<tt class="puredoc_idname">STANDARD_ESCAPE_EX</tt>がまるごと変わっている。これは、「<tt class="puredoc_idname">&lt;</tt>及び<tt class="puredoc_idname">&gt;</tt>がタグを構成する一部か」を判定する部分が甘かったからなのだが、ちょっとハマったのが、るりまには書かれていない「後読みアサーションに量指定子は使えない」という仕様だった。どうしても量指定子を使いたかったので、選択(<tt class="puredoc_idname">?</tt>)でタグを構成する場合はタグ全体がマッチするようにした。このようにすると、<tt class="puredoc_idname">case</tt>文で判定しているのは文字が含まれているかではなく、文字が<tt class="puredoc_idname">===</tt>でマッチするかであるため（標準では文字列の同一性を見る）、タグ全体がマッチした場合は<tt class="puredoc_idname">case</tt>文でのマッチに失敗する。マッチに失敗した場合は<tt class="puredoc_idname">else</tt>でマッチ文字列全体を返すため<tt class="puredoc_idname">String#grub</tt>の内容が唯一の<tt class="puredoc_idname">case</tt>文である時それにマッチしない文字列は変更されない。結果的に「タグを構成しているとみられる文字列は変更しない」となる。</p><p>なお、<tt class="puredoc_idname">#esc</tt>メソッドはこのように「タグ、もしくは文字参照と見られる文字列はエスケープしない」が、これは全ての要素メソッドが自動的に呼ぶためで、ユーザーが明示的にエスケープしたい場合は<tt class="puredoc_idname">#esc!</tt>メソッドを呼ぶことで対応できる。これは、このような判定は一切行わず、全ての当該シンボルをエスケープする。</p><p>なお、PureDocは特殊文字入力にHTML/XMLの文字参照を使うことになっている。そのため文字参照のエスケープを回避しているのだが、HTML以外への編訳においては当然文字参照のアンエスケープまたは変換が必要となる。</p>
<!-- PBSEARCH_RESULT -->
        </article>
    </section>
    <footer id="InfoFooter">
      <ul>
        <li>© Masaki Haruka 2003.</li>
        <li>Generated by <a href="https://gitlab.com/reasonset/pbsimply-wpimporter">PureBuilder Simply WP Importer</a></li>
      </ul>
    </footer>
  </body>
</html>
