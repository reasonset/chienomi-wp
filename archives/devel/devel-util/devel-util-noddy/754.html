<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="ja" xml:lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="generator" content="PureBuilder Simply WP Importer" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
    <meta name="author" content="Masaki Haruka" />
    <meta name="date" content="2015-10-01T00:00:00+09:00" />
    <meta name="dcterms.date" content="2015-10-01T00:00:00+09:00" />
    <title>Pureminder (リマインダ)とZsh socket programming - Chienomi</title>
    <style type="text/css">article {
max-width: 1080px;
margin: auto;
}</style>
  </head>
  <body>

    <section id="ContentContainer">
      <header id="MainHeader"><a href="/"><h1>Chienomi</h1></a></header>
      <section id="ArticleBox">
        <header id="ArticleTitle"><h1>Pureminder (リマインダ)とZsh socket programming</h1></header>
        <article id="MainArticle">

<p>Tasqueにはリマインダ機能がない。</p>

<p>Taskcoachということも考えはするが、残念ながらTaskcoachは私の環境ではSystem trayに収まってくれないため、非常に邪魔である。</p>

<p>そこで、リマインダを作ってみた。<a href="https://github.com/reasonset/pureminder">GitHubで公開している</a>。今回はどちらかというとNoddy寄りだが、きちんとした形で公開している。</p>

<p>PureminderはZshで書かれている、クライアント/サーバーである。
サーバーはメッセージを受け取り、SOX(<code>play</code>)で音を再生し、Zenityで画面に表示する。</p>

<p>わざわざクライアントサーバーモデルをとっているのは、atでの利用に問題があるためだ。</p>

<p>単にatでcallすると、Zenityは表示すべきディスプレイサーバーを見つけられない。
<code>$DISPLAY</code>変数によって指定することはできるが、マルチユーザー環境での動作が信用できない。</p>

<p>そこで、確実に機能させるため、現在のデスクトップ上で起動し、ユーザー別に作られるUNIXドメインソケットでメッセージを受け取る、という仕様とした。</p>

<p>だが、PureminderはZshだ。
一般にはなかなか見かけることのない、Zsh socket programmingをちょっと紹介しよう。</p>

<p>まず、モジュールをロードする。</p>

<pre><code>zmodload zsh/net/socket
</code></pre>

<p>次に<code>zsocket -l</code>でソケットを作成する。</p>

<pre><code>zsocket -l "$sockfile"
</code></pre>

<p><code>$REPLY</code>にファイルデスクリプタ(Integer)が入るので、とっておく。</p>

<pre><code>typeset -g sock=$REPLY
</code></pre>

<p><code>zsocket -a</code>で接続を待ち受ける。引数はソケットのファイルデスクリプタ。</p>

<pre><code>zsocket -va $sock
</code></pre>

<p><code>$REPLY</code>に接続のファイルデスクリプタが入る。この接続は全二重。
閉じる時は次のようにする。</p>

<pre><code>exec {fd}&gt;&amp; -
</code></pre>

<!-- PBSEARCH_RESULT -->
        </article>
    </section>
    <footer id="InfoFooter">
      <ul>
        <li>© Masaki Haruka 2003.</li>
        <li>Generated by <a href="https://gitlab.com/reasonset/pbsimply-wpimporter">PureBuilder Simply WP Importer</a></li>
      </ul>
    </footer>
  </body>
</html>
