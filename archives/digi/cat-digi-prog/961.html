<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="ja" xml:lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="generator" content="PureBuilder Simply WP Importer" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
    <meta name="author" content="Masaki Haruka" />
    <meta name="date" content="2016-06-26T00:00:00+09:00" />
    <meta name="dcterms.date" content="2016-06-26T00:00:00+09:00" />
    <title>MailDeliver2に「確認できる着信通知」 - Chienomi</title>
    <style type="text/css">article {
max-width: 1080px;
margin: auto;
}</style>
  </head>
  <body>

    <section id="ContentContainer">
      <header id="MainHeader"><a href="/"><h1>Chienomi</h1></a></header>
      <section id="ArticleBox">
        <header id="ArticleTitle"><h1>MailDeliver2に「確認できる着信通知」</h1></header>
        <article id="MainArticle">
<ul id="markdown-toc">
  <li><a href="#動機" id="markdown-toc-動機">動機</a></li>
  <li><a href="#苦戦" id="markdown-toc-苦戦">苦戦</a></li>
  <li><a href="#Yadのspecial character" id="markdown-toc-Yadのspecial character">Yadのspecial character</a></li>
</ul>

<h3 id="動機">動機</h3>

<p>Cinnamonの通知機能は使いにくい。</p>

<p>通知はずっと残すか(どんどん増えて超重くなる)、表示が終了したら消すかしかない。
メールの着信通知をNotify Sendで出しているのだけれども、見逃していまうと確認しようがないと、通知が常時きてるような環境ではその時に見られないので、まず確認できない。</p>

<p>着信に気づいてから確認したいのだが、その機能がなかった。
そこで、かねてからの希望だった、「Systrayに常駐し、クリックするとこれまで受け取ったメールが確認できる」という機能を追加することにした。</p>

<p>30分くらい、と思ったが5時間ほどかかった。</p>

<h3 id="苦戦">苦戦</h3>

<p>まずSystrayをどう実現するかだが、<code>yad</code>を使った。
Zenityのforkらしいのだけれども、なんかだいぶ違う。</p>

<p>yadをどう使うかというのは随分悩んだ。
yadの<code>--command</code>ではクォートがエスケープされてしまうため、スペースで必ず分割されてしまう。そのため、置き換えが発生する部分は別にくくりだすしかない。
<code>--listen</code>で実行するコマンドを随時更新できるが、ここでも同様の問題があるし、そもそも標準入力から渡す方法というのは結構限られる。</p>

<p>結局3つに分割している。データ整形用のスクリプト、yadのcommandになるスクリプト、そしてyad自体を起動するスクリプトだ。</p>

<p>当初、4つだった。一時的に保存され、通知と共に消されてしまうヘッダをとっておくためのプラグインだが、不毛なので(そしてそれが必要になるプラグインはおそらく多いので)Maildeliver本体に組み込まれ、<code>LeaveHeaders</code>という設定を可能にした。</p>

<p>時間がかかったのは細かいミスが重なったわけで、未知のエラーには遭遇していない。</p>

<p>いずれにせよ、これでメールを遡って確認できるようになった。ダイアログのOKでクリア、cancelで保持だ。</p>

<p>Yadの起動をRubyで行っている理由は結構単純で、複雑なエスケープなしにスペースやspecial characterを含むエントリを分割するために行志向にしていて、行単位でargを与えるのがRubyだと楽だから。</p>

<h3 id="Yadのspecial character">Yadのspecial character</h3>

<p>結局yadでなくZenityを使っていたのは、Yadはエントリーに対して結構複雑なエスケープを必要とするためで、とりあえず手っ取り早い方法としてである。</p>

<p>簡単にいえば、Yadの<code>--list</code>でエントリが表示されなかったり、ひとつ上の内容が表示されたりしていた。
ドキュメントにないので自力で試した限り</p>

<ul>
  <li><code>&lt;</code>または<code>&amp;</code>が含まれる場合、そのエントリはテーブル的に上の項目をクローンする</li>
  <li>エスケープ方法はXML(<code>&amp;lt;</code>及び<code>&amp;amp;</code>)</li>
  <li>ところが<code>&amp;rt;</code>には対応しておらず、<code>&amp;</code>が含まれるためクローンされてしまう</li>
</ul>

<p>こういうわけのわからない仕様はやめてほしい。</p>

<!-- PBSEARCH_RESULT -->
        </article>
    </section>
    <footer id="InfoFooter">
      <ul>
        <li>© Masaki Haruka 2003.</li>
        <li>Generated by <a href="https://gitlab.com/reasonset/pbsimply-wpimporter">PureBuilder Simply WP Importer</a></li>
      </ul>
    </footer>
  </body>
</html>
