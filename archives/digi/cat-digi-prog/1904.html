<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="ja" xml:lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="generator" content="PureBuilder Simply WP Importer" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
    <meta name="author" content="Masaki Haruka" />
    <meta name="date" content="2019-01-01T00:00:00+09:00" />
    <meta name="dcterms.date" content="2019-01-01T00:00:00+09:00" />
    <title>素晴らしきRinda - Chienomi</title>
    <style type="text/css">article {
max-width: 1080px;
margin: auto;
}</style>
  </head>
  <body>

    <section id="ContentContainer">
      <header id="MainHeader"><a href="/"><h1>Chienomi</h1></a></header>
      <section id="ArticleBox">
        <header id="ArticleTitle"><h1>素晴らしきRinda</h1></header>
        <article id="MainArticle">
<h2 id="rindaって">Rindaって</h2>
<p>Java生まれのTuppleSpaceのRuby実装である。</p>
<p>Javaの実装はLindaというので、RubyだからRindaということらしい。</p>
<p>Rindaは基本的に分散Ruby(dRuby)のデモンストレーションのようなライブラリのようだが、今(2.5.2)に至るまでずっと標準添付され続けている。</p>
<p>dRubyすらあまり使ったことのある人がいない中、dRubyはPStoreやYAMLStoreなどと同様、 「知っている人は少ないが使ったことのある人はほとんどいない」標準ライブラリになっている。</p>
<h2 id="tupplespaceって">TuppleSpaceって</h2>
<p>TuppleSpaceは共有して置いておけるプールである。</p>
<p>「ホワイトボードシステム」と呼ばれることが多いのでホワイトボードになぞらえるが、このホワイトボードにマグネットシートを貼ったり取ったりできる。 ボードから取ってくるマグネットシートは種類による選別が可能だ。</p>
<p>一般的なソケットと違い、違う種類のやり取りをひとつの経路に簡単に混ぜることができる。</p>
<p>TCPサーバーとして起動できるので、ネットワーク分散も可能だ。</p>
<h2 id="rindaの概要">Rindaの概要</h2>
<p>Rindaに対して置くことができるのは配列またはハッシュなのだが、「使い勝手はハッシュだが普通は配列」というのが私が感じている空気である。</p>
<p>例えば次のようなオブジェクトを配置する。</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode ruby"><code class="sourceCode ruby"><a class="sourceLine" id="cb1-1" title="1">ts.write([<span class="dv">10</span>, val])</a></code></pre></div>
<p>このメソッドはTuppleSpaceに接続し、この値を入力する間はブロックするが、受け取り手がいようがいまいが、すぐに終わる。 とにかく一旦TuppleSpaceに置かれるのだ。</p>
<p>そして、別のプロセスが次のようにして受け取る。</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode ruby"><code class="sourceCode ruby"><a class="sourceLine" id="cb2-1" title="1">ts.take([<span class="dv">10</span>, <span class="dv">nil</span>])</a></code></pre></div>
<p><code>nil</code>はワイルドカードになるので、<code>val</code>の値がなんだったかに関係なく受け取られる。 ただし、さらに他のプロセスが</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode ruby"><code class="sourceCode ruby"><a class="sourceLine" id="cb3-1" title="1">ts.write([<span class="dv">5</span>, val])</a></code></pre></div>
<p>のようにしていたら、この値は受け取らない。<code>[0]</code>に明に指定された値と異なるからだ。</p>
<h2 id="全体リソースの中での曖昧さ">全体リソースの中での曖昧さ</h2>
<p>サーバーでは無限にコネクションが維持できるわけではないし、無限にリソースがあるわけでもない。 そのため、処理できるものからどんどん処理していきたい、と考えるのだが、Rindaはこれによって「要請」と「結果」をプールしておくことができる。</p>
<p>例えば、次の例では検索クエリを受け取って、検索を行った結果をTuppleSpaceに置く。 クエリがないときはブロックする。</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode ruby"><code class="sourceCode ruby"><a class="sourceLine" id="cb4-1" title="1"><span class="kw">while</span> query = ts.take([<span class="st">:search</span>, <span class="dv">nil</span>, <span class="dv">nil</span>])</a>
<a class="sourceLine" id="cb4-2" title="2"></a>
<a class="sourceLine" id="cb4-3" title="3">  result = search(query[<span class="dv">2</span>])</a>
<a class="sourceLine" id="cb4-4" title="4">  ts.write([<span class="st">:result</span>, query[<span class="dv">1</span>], result])</a>
<a class="sourceLine" id="cb4-5" title="5"><span class="kw">end</span></a></code></pre></div>
<p>検索を要請する側がidを発行しておくことで、一意に応答することができる。 この処理を行うプロセスの数によって「並列で検索できるワーカーの数」を制御することができる。 余っているワーカーがあったとしてもそれは<code>Rinda::TuppleSpaceProxy#take</code>によってブロックされるだけであり、「同時最大並列数」だけプロセスを起動しておけば良い。</p>
<p>さらにこれを取っていくワーカーは別のホストでも構わないのだ。</p>
<p>TuppleSpaceによって簡単に分散処理、並列処理が可能なのだが、 これは「入れた順番には出てこない」。処理が大量にたまってしまった場合でも順番を守って処理してほしい場合には適さない。</p>
<p>だが、「手が空いているならば仕事を持ってきて処理する」という形式はなんとも人間的で、かつコンピュータ的にも結構優れたモデルだと思うのだ。 Rindaが有効に機能するように設計することにより、並列処理に伴う難しさをかなり軽減することができる。 そもそも並列処理は厳密さを求めるにはあまり向いていないので、このようなふわっとしたレイヤーをはさむと結構いい感じに動作する。</p>
<h2 id="in-action">in action</h2>
<p>今回は「ワーカーが処理するデータはそのワーカー単独が処理するディレクトリに分割し、ワーカーは処理が終了したらRinda経由でディレクトリパスを取得する」という方法をとった。</p>
<p>以前はHTMLチャットサーバーの実装で、要求に対して即座にリターンさせるためにRindaを使っていたこともある。</p>
<p>あまり知られておらず、使われる機会もないが、使ってみると結構面白いのではなかろうか。</p>

<!-- PBSEARCH_RESULT -->
        </article>
    </section>
    <footer id="InfoFooter">
      <ul>
        <li>© Masaki Haruka 2003.</li>
        <li>Generated by <a href="https://gitlab.com/reasonset/pbsimply-wpimporter">PureBuilder Simply WP Importer</a></li>
      </ul>
    </footer>
  </body>
</html>
