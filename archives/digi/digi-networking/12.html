<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="ja" xml:lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="generator" content="PureBuilder Simply WP Importer" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
    <meta name="author" content="Masaki Haruka" />
    <meta name="date" content="2014-05-08T00:00:00+09:00" />
    <meta name="dcterms.date" content="2014-05-08T00:00:00+09:00" />
    <title>VPS * DeleGate によるフロントエンドサーバーを用いたインターネットサーバー - Chienomi</title>
    <style type="text/css">article {
max-width: 1080px;
margin: auto;
}</style>
  </head>
  <body>

    <section id="ContentContainer">
      <header id="MainHeader"><a href="/"><h1>Chienomi</h1></a></header>
      <section id="ArticleBox">
        <header id="ArticleTitle"><h1>VPS * DeleGate によるフロントエンドサーバーを用いたインターネットサーバー</h1></header>
        <article id="MainArticle">
<h3>概要</h3><p>
IPv6への移行がこれほどまでに叫ばれているのに、世の中は全くIPv6に移行する気配がない。IPv4の枯渇はであり、そうなるとグローバルアクセス可能なインターネットサーバーというのは極めて難しい。重大な問題は、グローバルIPアドレスの価値が高すぎること、そしてISPが自宅サーバーを阻む方向にあることだ。</p>
<p>そこでよい対応方法のひとつとして、グローバルアクセス可能なVPSをリバースプロキシとして、という方法があり、さらにいえばVPNを汲むことでVPSをフロントエンド（ルーター）とするサイトを構築することも可能だ。</p>
<p>今回はとりあえず、「VPSを使ってインターネットにサービスを公開する」ところまで事を進めた。
</p><h3>事前準備</h3><p>
少なくともVPSと独自ドメインが必要不可欠だ。別に無料サブドメインでも問題はない。ただし、VPSは将来的にはVPNを汲むことが可能な、つまりはpppあるいはtunデバイスが利用可能なrootサーバーである必要がある。</p>
<p>私は今回、サーバーとしてDTI ServerMan、ドメインはXDomainを利用した。契約書を熟読するのに、何より時間がかかった。契約そのものは簡単で、特にクレジットカード決済ができる人ならあっという間だが。</p>
<p>そして、VPSを安全な状態にセットアップするまでがまた一手間。基本的手順としては、
</p><ul>
	<li>一般ユーザーを作る</li>
	<li>一般ユーザーのパスワードを強固なものにする</li>
	<li>SSHのポートを変える</li>
	<li>rootパスワードを強固なものにする</li>
	<li>usermodでwheelグループに追加</li>
	<li>visudo</li>
	<li>FirewallをConnected/ICMP/SSHのみ透過するように変更</li>
	<li>アップデート</li>
	<li>不要なサービスを止める</li>
</ul><p>
といったところになる。CentOSでのこうした個々の作業は情報が豊富なので、私は繰り返さない。各自調べてほしい。</p>
<p>この状態では基本的に何もできないので、サーバーを停止しておいたほうが安全である。</p>
<p>レジストラの方でリゾルバの設定(DNSレコードの設定)を行えばVPSに名前でアクセスできるようになる。普通はここで、VPS自身でサービスを起動し、ファイアウォールを設定してサービスを提供する。</p>
<p>私はとりあえずXDomain側でサービスを開始した。XDomainで設定しても独自ドメインでのサービスは提供できるのだが、フルカスタマイズはできないし、将来的にフロントエンドの変更が生じる場合があるので、やめておいた。
</p><h3>DeleGate</h3><p>
DeleGateは汎用のプロキシデーモンだ。HTTP/FTP/NTP/NNTP/Socks/SSH/SMTP/POP3/IMAP4などのアプリケーションゲートウェイ（リバースプロキシを含む）として機能するばかりでなく、ネットワークレベルゲートウェイとしても機能する。つまり、TCP/UDPパケットを転送することも可能。単純にこれをリバースプロキシとして動作させるだけでもかなり多くのサービスが提供できる。</p>
<p>ただ、CentOSにはDeleGateのパッケージがない。かつてはプロキシサーバーといえば、というほど有名だったが、今はマイナーなようだ。そこで手動導入したのだが、思わぬ問題が立ちふさがった。テスト環境はx86_64で、本番環境はi586ということが判明し、同じパッケージが導入できないのだ。そこで、本番環境はRPMで導入、一方テスト環境は</p><samp style="display: block;"> <kbd>yum install gcc gcc-c++ make openssl-devel</kbd>
# <kbd>wget <var>URI</var></kbd>
# <kbd>tar xvf <var>file</var></kbd>
# <kbd>cd delegate9.9.8</kbd>
# <kbd>make</kbd>
# <kbd>cp src/delegated /usr/local/sbin/</kbd></samp><p></p>
<p>これで最低限動作はするようになる。セキュリティや細かな設定は別として。</p>
<p>さて、テスト環境では</p><samp style="display: block;">delegated -P 80 MOUNT="/journal/* <var>blogURI</var>/*" </samp><p></p>
<p>で動作してくれたのだが、本番はそうはいかず、checksum生成をした上で</p><samp style="display: block;">delegated -P 80 MOUNT="/journal/* <var>blogURI</var>/*" PERMIT="http:*:*"</samp><p></p>
<p>としてあげる必要があった。
</p><h3>おまけ</h3><p>
無事動作したので、一区切りついたということでお祝いに寿司を食べてきた。</p>
<p>さらっと書いているが、結構大変な作業でトラブル続きだったことを報告しておく。</p>
<!-- PBSEARCH_RESULT -->
        </article>
    </section>
    <footer id="InfoFooter">
      <ul>
        <li>© Masaki Haruka 2003.</li>
        <li>Generated by <a href="https://gitlab.com/reasonset/pbsimply-wpimporter">PureBuilder Simply WP Importer</a></li>
      </ul>
    </footer>
  </body>
</html>
